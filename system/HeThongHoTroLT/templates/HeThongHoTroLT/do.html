{% extends pos %}

{% block content %}
{% load static %}
<!-- Begin Page Content -->

<div id="not_right_side" class="ic-app-main-content">
    <section class="content">
        <div id="content-wrapper" class="ic-Layout-contentWrapper" style='flex:0 0 70%;max-width:70%;width:70%;float: left;'>
            <div id="content" class="ic-Layout-contentMain" role="main">
                <h3 class="loading" style="display: none;">Đang tải...</h3>
                <div class="loaded" style="">
                    <header class="quiz-header">
                        <h1>{{ test.test_name }}</h1>
                        <div class="alert">
                            {% comment %} <i class="icon-warning" aria-label="Cảnh báo"></i>
                            Đây là bản xem trước của đề kiểm tra sẽ được công bố {% endcomment %}
                        </div>
                        Bắt đầu: {{ current_time }}
                    </header>
                    <form id="submit_quiz_form" class="one_question_at_a_time" action="{% url 'result_test' %}" accept-charset="UTF-8" method="post" onsubmit="return confirmSubmit();">
                        <input name="utf8" type="hidden" value="✓">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="hidden" name="test_id" value="{{ test.test_id }}">
                        <div id="questions" class="assessing">
                            {% for qa in question_answer_list %}
                            <div class="quiz_sortable question_holder" aria-label="Câu hỏi {{ forloop.counter }}">
                                <div class="display_question question multiple_choice_question" id="question_{{ qa.question.question_id }}">
                                    <div class="move">
                                        <a class="draggable-handle" role="button" tabindex="0">
                                            <i class="icon-drag-handle">
                                                <span class="screenreader-only">Chuyển tới...</span>
                                                <span class="accessibility-warning screenreader-only">Phần tử này là một thay thế dễ tiếp cận hơn để kéo và thả sắp xếp lại. Nhấn Enter hoặc Space để di chuyển câu hỏi này.</span>
                                            </i>
                                        </a>
                                    </div>
                                    <div class="header">
                                        <span class="name question_name" role="heading" aria-level="2">Câu hỏi {{ forloop.counter }}</span>
                                        <span>(Cấp độ: </span>
                                        <span class="question_level_name" role="heading">{{ qa.question.question_level }}</span>
                                        <span>)</span>
                                        {% comment %} <span class="question_points_holder">
                                            <span class="points question_points">{{ qa.question.points }}</span> điểm
                                        </span> {% endcomment %}
                                    </div>
                                    <div class="text">
                                        <div class="question_text user_content enhanced" id="question_{{ qa.question.question_id }}_question_text">
                                            <strong>{{ qa.question.question_content }}</strong>
                                        </div>
                                        <div class="answers">
                                            {% for choice in qa.answers %}
                                            <div class="answer">
                                                <label class="answer_row">
                                                    <input type="radio" class="question_input" name="question_{{ qa.question.question_id }}" value="{{ choice.answer_id }}" id="question_{{ qa.question.question_id }}_answer_{{ choice.answer_id }}">
                                                    <div class="answer_label">&nbsp;{{ choice.answer_content }}</div>
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <!-- Trường ẩn lưu câu trả lời của người dùng -->
                                <input type="hidden" name="answers[{{ qa.question.question_id }}]" id="answer_{{ qa.question.question_id }}" value="">
                            </div>
                            {% endfor %}
                        </div>
                        <!-- Nút nộp bài -->
                        <div class="submit-button">
                            {% if pos != 'HeThongHoTroLT/base_teacher.html'%}
                                <button type="submit" class="btn btn-primary">Nộp bài</button>
                            {%endif%}
                        </div>
                    </form>
                    {% if pos == 'HeThongHoTroLT/base_teacher.html'%}
                        <button type="submit" class="btn btn-primary" onclick="goBack()">Thoát</button>
                    {%endif%}
                </div>
            </div>
        </div>
        <div id="right-side-wrapper" class="ic-app-main-content__secondary" style='flex:0 0 30%;max-width:30%;width:30%;float: left;'>
            <aside id="right-side" role="complementary">
                <br>
                <h3 style="margin: 0px;">Câu hỏi</h3>
                <ul id="question_list" style="max-height: 200px; overflow: auto;" class="">
                    {% for qa in question_answer_list %}
                    <li id="list_question_{{ qa.question.question_id }}" class="list_question seen current_question">
                        <a class="no-warning" href="#question_{{ qa.question.question_id }}">
                            <i class="placeholder icon-question"></i>Câu hỏi {{ forloop.counter }}
                            <span class="screenreader-only marked-status"></span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                <div id="quiz-time-elapsed">
                    <span class="time_header">
                        Thời gian chạy:
                    </span>
                    <span style="font-size: 0.8em; padding-left: 10px;">
                        <a href="#" class="hide_time_link">Ẩn đi</a>
                    </span>
                    <div class="clear"></div>
                    <div class="time_running" id="time_running"></div>
                </div>
            </aside>
        </div>
    </section>
</div>
<!-- End of Main Content -->

</div>
<!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<!-- Logout Modal-->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                <a class="btn btn-primary" href="{% url 'login' %}">Logout</a>
            </div>
        </div>
    </div>
</div>

<!-- Script để hiện thông báo khi tải lại trang hoặc thoát trang -->
<script>
    window.addEventListener('beforeunload', function (e) {
        var confirmationMessage = 'Bài kiểm tra này sẽ không được lưu, huỷ mọi thao tác vừa thực hiện';
        e.returnValue = confirmationMessage; // Gecko, Trident, Chrome 34+
        return confirmationMessage; // Gecko, WebKit, Chrome <34
    });

    function confirmSubmit() {
        // Lấy tất cả các câu hỏi
        const questions = document.querySelectorAll('.display_question');
        let allAnswered = true;

        // Kiểm tra từng câu hỏi xem đã được trả lời chưa
        questions.forEach(function(question) {
            const questionId = question.id.split('_')[1];
            const answers = document.getElementsByName('question_' + questionId);
            let answered = false;
            for (let i = 0; i < answers.length; i++) {
                if (answers[i].checked) {
                    answered = true;
                    // Cập nhật giá trị cho trường ẩn
                    document.getElementById('answer_' + questionId).value = answers[i].value;
                    break;
                }
            }
            if (!answered) {
                allAnswered = false;
                question.scrollIntoView();
                question.classList.add('highlight');
                setTimeout(() => question.classList.remove('highlight'), 3000);
                alert('Bạn chưa hoàn thành câu hỏi số ' + questionId);
            }
        });

        if (!allAnswered) {
            return false;
        }

        return confirm('Bạn có chắc chắn muốn nộp bài?');
    }

    function goBack() {
        window.history.back();
    }

    // Countdown timer script
    function startTimer(duration, display) {
        var timer = duration, minutes, seconds;
        var oneMinuteWarningGiven = false; // Track if the one-minute warning has been given

        setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + " phút, " + seconds + " giây";

            if (timer <= 60 && !oneMinuteWarningGiven) {
                alert('Bạn chỉ còn 1 phút để nộp bài!');
                oneMinuteWarningGiven = true;
            }

            if (--timer < 0) {
                timer = 0;
                document.getElementById("submit_quiz_form").submit();  // Auto-submit the form when time is up
            }
        }, 1000);
    }

    window.onload = function () {
        var testTime = {{ test.test_time }} * 60; // Convert test time from minutes to seconds
        var display = document.querySelector('#time_running');
        startTimer(testTime, display);
    };
</script>

<style>
    .highlight {
        border: 2px solid red;
    }
</style>

{% endblock %}
